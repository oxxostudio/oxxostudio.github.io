<!DOCTYPE html><html lang="zh-TW"><head>
  <meta charset="UTF-8">
  <meta http-equiv="Cache-control" content="public">
  <meta http-equiv="max-age" content="864000">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="author" content="oxxo.studio">
  <meta name="copyright" content="oxxo.studio">
  <script>
      let uri = window.location.href;
      if(uri.indexOf('https')<0 && uri.indexOf('localhost')<0){
          window.location.replace(uri.replace('http','https'));
      }
  </script>

  <title>Firebase 教學 - Firestore Rules 安全規則 - OXXO.STUDIO</title>

  <meta name="description" content="Rules ( 安全規則 ) 可以讓 firestore 具有多一層的安全保護，firestore 的規則除了可以指定哪些資料可以讀取或寫入，也能更進一步的區分讀取與寫入的細部規則 ( 單一檔案、全部檔案、創建新檔案、更新檔案或刪除檔案...等 )，透過安全規則的設置，資料庫的使用也更靈活更安全。">
  <meta itemprop="description" content="Rules ( 安全規則 ) 可以讓 firestore 具有多一層的安全保護，firestore 的規則除了可以指定哪些資料可以讀取或寫入，也能更進一步的區分讀取與寫入的細部規則 ( 單一檔案、全部檔案、創建新檔案、更新檔案或刪除檔案...等 )，透過安全規則的設置，資料庫的使用也更靈活更安全。">
  <meta itemprop="image" content="https://www.oxxostudio.tw/img/articles/201907/firebase-firestore-rules.jpg">
  <meta property="og:description" content="Rules ( 安全規則 ) 可以讓 firestore 具有多一層的安全保護，firestore 的規則除了可以指定哪些資料可以讀取或寫入，也能更進一步的區分讀取與寫入的細部規則 ( 單一檔案、全部檔案、創建新檔案、更新檔案或刪除檔案...等 )，透過安全規則的設置，資料庫的使用也更靈活更安全。">
  <meta property="og:title" content="Firebase 教學 - Firestore Rules 安全規則">
  <meta property="og:url" content="https://www.oxxostudio.tw/articles/201907/firebase-firestore-rules.html">
  <meta property="og:image" content="https://www.oxxostudio.tw/img/articles/201907/firebase-firestore-rules.jpg">
  <link rel="canonical" href="https://www.oxxostudio.tw/articles/201907/firebase-firestore-rules.html">
  <style>body{display:none;}</style>
</head>

<body>
  <div id="header">
    <div id="top-menu">
      <ul class="top-menu-left">
        <li class="list" title="文章列表"><i></i><a href="/list.html">ARCHIVE</a></li>
        <li class="about" title="關於我"><i></i><a href="/articles/201405/about-me.html">ABOUT</a></li>
        <li class="contact" title="聯絡方式"><i></i><a href="/articles/201405/contact.html">CONTACT</a></li>
      </ul>
      <a href="/sitemap.xml" title="Sitemap" target="_blank">
        <div class="rss"><i></i></div>
      </a>
      <div class="search" title="站內搜尋">
        <div id="cse-search-form" style="width: 100%;">
          <gcse:searchbox-only></gcse:searchbox-only>
        </div>
      </div>
    </div>
    <div id="banner">
      <a href="/">
        <i class="bubble"></i>
        <i class="hihi"></i>
        <img src="/img/layout/banner.png">
        <h2>Design thinking is everywhere</h2>
      </a>
    </div>
    <div id="main-menu">
      <div class="mobile-menu"><span></span><span></span><span></span></div>
      <div class="menu">
        <a href="/"><i></i>ALL</a>
        <a href="/index.html?tag-creative"><i></i>Creative</a>
        <a href="/index.html?tag-ui"><i></i>UI &amp; UX</a>
        <a href="/index.html?tag-photo"><i></i>PHOTO</a>
        <a href="/index.html?tag-css"><i></i>CSS</a>
        <a href="/index.html?tag-web"><i></i>WEB TECH</a>
        <a href="/index.html?tag-share"><i></i>Share</a>
        <a href="/index.html?tag-others"><i></i>OTHERS</a>
        <a href="/list.html"><i></i>ARCHIVE</a>
      </div>
    </div>
    <div class="body-line"></div>
  </div>

  <main>
    <article>
      <i class="tag"></i>

<h1>Firebase 教學 - Firestore Rules 安全規則</h1> 
<p>Rules ( 安全規則 ) 可以讓 firestore 具有多一層的安全保護，firestore 的規則除了可以指定哪些資料可以讀取或寫入，也能更進一步的區分讀取與寫入的細部規則 ( 單一檔案、全部檔案、創建新檔案、更新檔案或刪除檔案...等 )，透過安全規則的設置，資料庫的使用也更靈活更安全。</p>
<blockquote>
<p>延伸閱讀：</p>
<ul>
<li><a href="/articles/201905/firebase-firestore.html">Firebase 教學 - Firestore 安裝、寫入和讀取</a></li>
<li><a href="/articles/201907/firebase-nodejs-firestore.html">Firebase 教學 - Node.js 操作 Firestore</a></li>
</ul>
</blockquote>
<div id="google-adsense-content"><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-8629612872829139" data-ad-slot="2613902930" data-matched-content-ui-type="image_card_stacked" data-matched-content-columns-num="3" data-matched-content-rows-num="1" data-ad-format="autorelaxed"></ins><script>(adsbygoogle = window.adsbygoogle || []).push({});</script></div><h2>基本寫法</h2> 
<p>所有 Firestore 的安全規則都包含了<code>match</code>和<code>allow</code>的語法，<code>match</code>負責識別哪些文件與資料夾，<code>allow</code>則負責相對應的權限，又分為<code>read</code>( 讀取 ) 和<code>write</code>( 寫入 ) 兩種，<code>read</code>可再細分為<code>get</code>和<code>list</code>，<code>wrtie</code>也可再細分為<code>create</code>、<code>update</code> 和 <code>delete</code>，如果單純指定<code>read</code>或<code>wrtie</code>的權限，則細分的規則就會全部按照父層的定義進行，透過這些規則的交互搭配，就能提高資料庫的彈性與安全性。</p>
<table>
<thead>
<tr>
<th>類型</th>
<th>說明</th>
</tr>
</thead>
<tbody>
<tr>
<td><em>(read) get</em></td>
<td>知道文件路徑就可讀取</td>
</tr>
<tr>
<td><em>(read) list</em></td>
<td>讀取所有文件時就可被讀取</td>
</tr>
<tr>
<td><em>(write) create</em></td>
<td>建立文件</td>
</tr>
<tr>
<td><em>(write) update</em></td>
<td>更新文件</td>
</tr>
<tr>
<td><em>(wrtie) delete</em></td>
<td>刪除文件</td>
</tr>
</tbody>
</table>
<p>基本的寫法如下，最外層的兩行不需要更動，因它代表這整份資料庫的路徑，，內層透過<code>match</code>篩選指定的路徑，並由 if 條件判斷 true 或 false 來決定讀取或寫入的權限。</p>
<pre class="prettyprint"><code>service cloud.firestore {                  // 不需更動
  match /databases/{database}/documents {  // 不需更動
    match /路徑 {
      allow read, write: if 條件判斷;
    }
  }
}
</code></pre><p>當我們建立了一個 firestore 的資料庫，預設的規則會像下面這個樣子，內層的<code>match</code>透過「萬用字元」指定資料庫下「所有的文件」都可以寫入和讀取，也就等同於只要知道資料庫路徑的所有人都可以操作這個資料庫。</p>
<pre class="prettyprint"><code>service cloud.firestore {                  // 不需更動
  match /databases/{database}/documents {  // 不需更動
    match /{document=**} {
      allow read, write;
    }
  }
}
</code></pre><h2>定義規則</h2> 
<p>以下規則將使用「<a href="https://www.oxxostudio.tw/articles/201905/firebase-firestore.html" target="_blank">Firebase 教學 - Firestore 安裝、寫入和讀取</a>」裡的專案作為範例，專案結構如下圖為一個包含五種水果名字文件的 fruit 集合。</p>
<p><img class="lazy" src="/img/layout/loading.gif" data-src="/img/articles/201907/firebase-firestore-rules-01.jpg" alt=""></p>
<p>如果我們把規則寫成<code>match /fruit/{document}</code>，因為只有單一個集合，那麼它的效果幾乎等同於<code>match /{document=**}</code>，使用模擬工具測試可以看到，針對 fruit 裡的 orange 文件，可以允許寫入資料。</p>
<pre class="prettyprint"><code>service cloud.firestore {
  match /databases/{database}/documents {
    match /fruit/{document} {
      allow read, write;
    }
  }
}
</code></pre><p><img class="lazy" src="/img/layout/loading.gif" data-src="/img/articles/201907/firebase-firestore-rules-02.jpg" alt=""></p>
<p>如果 allow 後方不加入 if 條件判斷，預設就會 true，如果不寫 allow，預設則是 false，舉例來說，下面這兩段規則的結果相同，只能讀取資料庫，而不能寫入資料庫。</p>
<pre class="prettyprint"><code>service cloud.firestore {
  match /databases/{database}/documents {
    match /fruit/{document} {
      allow read;
    }
  }
}
</code></pre><p><img class="lazy" src="/img/layout/loading.gif" data-src="/img/articles/201907/firebase-firestore-rules-03.jpg" alt=""></p>
<pre class="prettyprint"><code>service cloud.firestore {
  match /databases/{database}/documents {
    match /fruit/{document} {
      allow read;
      allow write: if false;
    }
  }
}
</code></pre><p><img class="lazy" src="/img/layout/loading.gif" data-src="/img/articles/201907/firebase-firestore-rules-04.jpg" alt=""></p>
<h2>規則的分層與交集</h2> 
<p>撰寫規則不限有幾個<code>match</code>，但若匹配到同一個文件，<em>只要任何一個<code>allow</code>的判斷回傳 true，就擁有權限可以允許讀取或寫入</em>，以下方的規則來說，雖然我們定義了 /fruit/apple 不可以寫入，但因為 /fruit/{document} 回傳了 true，所以 apple 文件仍然保有寫入的權限。</p>
<pre class="prettyprint"><code>service cloud.firestore {
  match /databases/{database}/documents {
    match /fruit/apple {
      allow read;
      allow write: if false;
    }
    match /fruit/{document} {
      allow read, write;
    }
  }
}
</code></pre><p><img class="lazy" src="/img/layout/loading.gif" data-src="/img/articles/201907/firebase-firestore-rules-05.jpg" alt=""></p>
<p>延續上面所提到的「萬用字元」( 被<code>{}</code>包起來的變數 )，規則裡的<code>{document}</code>表示「該層」所有的文件，如果指令更深層的文件規則，不同層的規則無法互相覆蓋，舉例來說，下方的規則雖然把 /fruit/{document} 定義為可以寫入，但因更深層 /fruit/{document}/{col}/{doc} 的規則定義為不能寫入，因此就無法存入資料。</p>
<pre class="prettyprint"><code>service cloud.firestore {
  match /databases/{database}/documents {
    match /fruit/{document} {
      allow read, write;
    }
    match /fruit/{document}/{col}/{doc} {
      allow read;
      allow write: if false;
    }
  }
}
</code></pre><p>第一層 apple 可以寫入資料。</p>
<p><img class="lazy" src="/img/layout/loading.gif" data-src="/img/articles/201907/firebase-firestore-rules-06.jpg" alt=""></p>
<p>apple 的下一層則無法寫入資料。</p>
<p><img class="lazy" src="/img/layout/loading.gif" data-src="/img/articles/201907/firebase-firestore-rules-07.jpg" alt=""></p>
<p>不過如果我們把萬用字元改成<code>{document=**}</code>，表示該層以下所有的文件，也因此後方的判斷就會無效，變成可以寫入資料了。</p>
<p><img class="lazy" src="/img/layout/loading.gif" data-src="/img/articles/201907/firebase-firestore-rules-08.jpg" alt=""></p>
<h2>簡單實現資料的保護</h2> 
<p>最基本保護資料的方法有兩種，一種是不能修改已有的檔案，一種就是透過簡單的使用者認證來保護，首先看到第一種「不能修改已有的檔案」，在 firestore 裡要實作還滿簡單的，只要把 read 和 write 再細分規範，就能實現對應的保護，下面的規則會<em>限制不能更新與刪除已存在的檔案，但仍然可以新建檔案</em>。</p>
<pre class="prettyprint"><code>service cloud.firestore {
  match /databases/{database}/documents {
    match /fruit/{document=**} {
      allow read, create;
      allow delete: if false;
      allow update: if false;
    }
  }
}
</code></pre><p>至於下面這段規則，表示「<em>如果知道該文件的路徑</em>」就能讀取該文件，但若要<em>讀取整份文件則會被規則拒絕</em>。</p>
<pre class="prettyprint"><code>service cloud.firestore {
  match /databases/{database}/documents {
    match /fruit/{document=**} {
      allow get;
      allow list: if false;
      allow create;
      allow delete: if false;
      allow update: if false;
    }
  }
}
</code></pre><p>而我們也可以單純透過資料本身的屬性來定義，下方的規則定義了「<em>如果資料有 visibility 為 public 才可以讀取</em>」。</p>
<pre class="prettyprint"><code>service cloud.firestore {
  match /databases/{database}/documents {
    match /fruit/{document=**} {
      allow read: if resource.data.visibility == 'public';
    }
  }
}
</code></pre><p>規則也可以強制使用者登入後才能讀取或寫入，下方的規則使用了<code>request.auth.uid</code>的方法，取得註冊用戶的 uid，<em>如果沒有 uid 則禁止讀取或寫入</em>。</p>
<blockquote>
<p>註冊使用者的方法和 RealTime Database 一模一樣，只需把資料庫的部分換成 Firestore 即可，請參考：<a href="https://www.oxxostudio.tw/articles/201905/firebase-simple-signup.html" target="_blank">Firebase 教學 - 簡單的使用者註冊功能</a></p>
</blockquote>
<pre class="prettyprint"><code>service cloud.firestore {
  match /databases/{database}/documents {
    match /fruit/{document=**} {
      allow read, write: if request.auth.uid != null;
    }
  }
}
</code></pre><p>當然我們也可以把規則寫得更完整，下方的規則可以<em>指定使用者僅能讀取或寫入屬於自己的文件</em>。</p>
<pre class="prettyprint"><code>service cloud.firestore {
  match /databases/{database}/documents {
    match /fruit/{document=**} {
      allow read, update, delete: if request.auth.uid == resource.data.author_id;
      allow create: if request.auth.uid != null;
    }
  }
}
</code></pre><h2>小結</h2> 
<p>整體來說，我覺得 Firestore 的規則比 RealTime Database 的規則還要有彈性，實作起來在理解上也差不多，本篇文章所介紹的規則應該可以滿足大多數的使用情境，不過如果有更複雜的流程，就得在規則上多加琢磨了。</p>
<blockquote>
<p>參考：<a href="https://firebase.google.com/docs/reference/rules/rules#properties" target="_blank">Cloud Firestore Rules</a></p>
</blockquote>


      <div class="social-icon">
        <a class="icon-home" href="/index.html"><i></i><span>Back Home</span></a>
        <a class="icon-list" href="/list.html"><i></i><span>Article List</span></a>
        <a class="icon-facebook" target="_blank"><i></i><span>Share on Facebook</span></a>
        <a class="icon-google" target="_blank"><i></i><span>Share on Google+</span></a>
        <a class="icon-twitter" target="_blank"><i></i><span>Share on Twitter</span></a>
        <a class="goto-top"><i></i><span>Back to Top</span></a>
      </div>
      <a class="arrow arrow-left">
        <i></i>
      </a>
      <a class="arrow arrow-right">
        <i></i>
      </a>

    </article>
  </main>
  <div class="recommend">
      <div class="closeBtn"></div>
      <h4>有興趣瞧瞧其他新文章嗎？</h4>
      <ul></ul>
  </div>
  <div id="other-articles">
    <div class="previous-next previous-article">
      <span>前一篇文章：</span>
      <br>
      <h4></h4>
    </div>
    <div class="previous-next next-article">
      <span>下一篇文章：</span>
      <br>
      <h4></h4>
    </div>
    <h3>您可以閱讀其他相關文章，或瀏覽 <a href="/list.html">所有文章</a></h3>
  </div>
  <div id="google-adsense">
    <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-8629612872829139" data-ad-slot="8489880299" data-matched-content-ui-type="image_card_stacked" data-matched-content-rows-num="1" data-matched-content-columns-num="4" data-ad-format="autorelaxed"></ins>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
  </div>
  <div id="disqus">
    <div id="disqus_thread"></div>
  </div>
  <div id="footer">
    <div class="footer-line"></div>
    <div class="license">Copyright 2019 | All Rights Reserved. Designed by <a href="/">OXXO.STUDIO</a></div>
  </div>

  <link href="/css/article.css?20190821" rel="stylesheet">
  <script src="https://www.google.com/jsapi"></script>
  <script>
    (function (i, s, o, g, r, a, m) {
      i['GoogleAnalyticsObject'] = r;
      i[r] = i[r] || function () {
        (i[r].q = i[r].q || []).push(arguments)
      }, i[r].l = 1 * new Date();
      a = s.createElement(o),
        m = s.getElementsByTagName(o)[0];
      a.async = 1;
      a.src = g;
      m.parentNode.insertBefore(a, m)
    })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

    ga('create', 'UA-2708968-3', 'auto');
    ga('send', 'pageview');
  </script>
  <script src="/js/layout.js?20190612"></script>
  <script src="/js/articles.js?20190724"></script>
  <!-- highlight -->
  <style>
  .hljs{display:block;overflow-x:auto;padding:20px;background:#232323;color:#e9e9e9}.hljs-comment,.hljs-quote{color:#bc9458;font-style:italic}.hljs-keyword,.hljs-selector-tag{color:#c26230}.hljs-string,.hljs-number,.hljs-regexp,.hljs-variable,.hljs-template-variable{color:#a5c261}.hljs-subst{color:#519f50}.hljs-tag,.hljs-name{color:#e8bf6a}.hljs-type{color:#da4939}.hljs-symbol,.hljs-bullet,.hljs-built_in,.hljs-builtin-name,.hljs-attr,.hljs-link{color:#6dacde;}.hljs-params{color:#d0d0ff}.hljs-attribute{color:#cda869}.hljs-meta{color:#9b859d}.hljs-title,.hljs-section{color:#ffc66d}.hljs-addition{background-color:#144212;color:#e6e1dc;display:inline-block;width:100%}.hljs-deletion{background-color:#600;color:#e6e1dc;display:inline-block;width:100%}.hljs-selector-class{color:#9b703f}.hljs-selector-id{color:#8b98ab}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:bold}.hljs-link{text-decoration:underline}
  </style>
  <script src="/js/lib/highlight.pack.js"></script>
  <script>
    document.querySelectorAll('pre code').forEach(e => {
      hljs.highlightBlock(e);
    });
  </script>
  <script>
    const showAD = () => {
      let element = document.createElement("script");
      element.src = "//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js";
      document.body.appendChild(element);
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8629612872829139",
        enable_page_level_ads: true
      });
      window.removeEventListener('scroll', showAD);
    }
    window.addEventListener('scroll', showAD);
  </script>
  <script>
    const showDisqus = () => {
      let scrollTop = this.pageYOffset;
      let bodyHeight = document.body.clientHeight;
      if (scrollTop > bodyHeight / 2) {
        let dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//oxxostudio.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        window.removeEventListener('scroll', showDisqus);
      }
    };
    window.addEventListener('scroll', showDisqus);
  </script>



</body></html>